// ============================================
// Awesome Mac - Prisma Schema
// ============================================
// PostgreSQL Schema Definition
// ============================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "fullTextIndex"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// MODELS
// ============================================================================

model Category {
  id          String     @id @default(uuid()) @db.Uuid
  name        String     @db.VarChar(255)
  slug        String     @unique @db.VarChar(255)
  description String?    @db.Text
  parentId    String?    @map("parent_id") @db.Uuid
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    Category[] @relation("CategoryHierarchy")
  sortOrder   Int        @default(0) @map("sort_order")
  depth       Int        @default(0)
  metadata    Json       @default("{}") @db.JsonB
  createdAt   DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime   @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt   DateTime?  @map("deleted_at") @db.Timestamptz(6)

  // Relations
  apps        App[]

  @@index([slug])
  @@index([parentId])
  @@index([sortOrder])
  @@index([depth])
  @@map("categories")
}

model App {
  id              String       @id @default(uuid()) @db.Uuid
  name            String       @db.VarChar(255)
  slug            String       @unique @db.VarChar(255)
  description     String?      @db.Text
  url             String       @db.Text
  categoryId      String       @map("category_id") @db.Uuid
  category        Category     @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  // Flags
  isFree          Boolean      @default(false) @map("is_free")
  isOpenSource    Boolean      @default(false) @map("is_open_source")
  isAppStore      Boolean      @default(false) @map("is_app_store")
  hasAwesomeList  Boolean      @default(false) @map("has_awesome_list")

  // URLs
  githubUrl       String?      @map("github_url") @db.Text
  appStoreUrl     String?      @map("app_store_url") @db.Text
  awesomeListUrl  String?      @map("awesome_list_url") @db.Text
  iconUrl         String?      @map("icon_url") @db.Text

  // Status and pricing
  status          AppStatus    @default(ACTIVE)
  pricing         PricingModel?

  // Popularity metrics
  viewCount       Int          @default(0) @map("view_count")
  clickCount      Int          @default(0) @map("click_count")

  // GitHub metadata
  githubStars     Int?         @map("github_stars")
  githubLastSyncAt DateTime?   @map("github_last_sync_at") @db.Timestamptz(6)

  // Metadata
  metadata        Json         @default("{}") @db.JsonB

  // Timestamps
  createdAt       DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt       DateTime?    @map("deleted_at") @db.Timestamptz(6)

  // Relations
  tags            AppTag[]
  analyticsEvents AnalyticsEvent[]

  @@index([slug])
  @@index([categoryId])
  @@index([url])
  @@index([status])
  @@index([isFree])
  @@index([isOpenSource])
  @@index([isAppStore])
  @@index([viewCount(sort: Desc)])
  @@index([deletedAt], where: [{ deletedAt: null }])
  @@map("apps")
}

model Tag {
  id          String    @id @default(uuid()) @db.Uuid
  name        String    @unique @db.VarChar(100)
  slug        String    @unique @db.VarChar(100)
  description String?   @db.Text
  color       String?   @db.VarChar(7)
  sortOrder   Int       @default(0) @map("sort_order")
  metadata    Json      @default("{}") @db.JsonB
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  apps        AppTag[]

  @@index([slug])
  @@map("tags")
}

model AppTag {
  appId      String   @map("app_id") @db.Uuid
  tagId      String   @map("tag_id") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  app        App      @relation(fields: [appId], references: [id], onDelete: Cascade)
  tag        Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([appId, tagId])
  @@index([appId])
  @@index([tagId])
  @@map("app_tags")
}

model AnalyticsEvent {
  id                String    @id @default(uuid()) @db.Uuid
  eventType         String    @map("event_type") @db.VarChar(50)
  appId             String?   @map("app_id") @db.Uuid
  categoryId        String?   @map("category_id") @db.Uuid
  sessionId         String?   @map("session_id") @db.VarChar(255)
  userAgent         String?   @map("user_agent") @db.Text
  referrer          String?   @db.Text
  ipAddress         String?   @map("ip_address") @db.VarChar(45)
  countryCode       String?   @map("country_code") @db.Char(2)
  searchQuery       String?   @map("search_query") @db.Text
  searchResultsCount Int?     @map("search_results_count")
  filterData        Json?     @map("filter_data") @db.JsonB
  dateBucket        DateTime  @default(now()) @map("date_bucket") @db.Date
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  app               App?      @relation(fields: [appId], references: [id], onDelete: SetNull)

  @@index([createdAt(sort: Desc)])
  @@index([dateBucket])
  @@index([eventType])
  @@index([appId])
  @@index([categoryId])
  @@index([sessionId])
  @@index([eventType, dateBucket(sort: Desc)])
  @@map("analytics_events")
}

model WebVital {
  id             String       @id @default(uuid()) @db.Uuid
  metricName     String       @map("metric_name") @db.VarChar(10)
  value          Decimal      @db.Numeric(10, 3)
  rating         Rating
  delta          Decimal      @db.Numeric(10, 3)
  metricId       String       @map("metric_id") @db.VarChar(255)
  page           String       @db.VarChar(500)
  sessionId      String?      @map("session_id") @db.VarChar(255)
  userAgent      String?      @map("user_agent") @db.Text
  connectionType String?      @map("connection_type") @db.VarChar(50)
  dateBucket     DateTime     @default(now()) @map("date_bucket") @db.Date
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([dateBucket(sort: Desc)])
  @@index([metricName])
  @@index([rating])
  @@index([page])
  @@map("web_vitals")
}

model SyncLog {
  id                String    @id @default(uuid()) @db.Uuid
  syncType          String    @map("sync_type") @db.VarChar(50)
  status            String    @db.VarChar(50)
  appsCreated       Int       @default(0) @map("apps_created")
  appsUpdated       Int       @default(0) @map("apps_updated")
  appsDeleted       Int       @default(0) @map("apps_deleted")
  appsSkipped       Int       @default(0) @map("apps_skipped")
  categoriesCreated Int       @default(0) @map("categories_created")
  categoriesUpdated Int       @default(0) @map("categories_updated")
  errorMessage      String?   @map("error_message") @db.Text
  errorCount        Int       @default(0) @map("error_count")
  sourceFile        String?   @map("source_file") @db.Text
  durationMs        Int?      @map("duration_ms")
  metadata          Json      @default("{}") @db.JsonB
  startedAt         DateTime  @default(now()) @map("started_at") @db.Timestamptz(6)
  completedAt       DateTime? @map("completed_at") @db.Timestamptz(6)

  @@index([startedAt(sort: Desc)])
  @@index([status])
  @@index([syncType])
  @@map("sync_logs")
}

// ============================================================================
// ENUMS
// ============================================================================

enum AppStatus {
  ACTIVE
  DEPRECATED
  REMOVED
  PENDING
}

enum PricingModel {
  FREE
  FREEMIUM
  PAID
  OPEN_SOURCE
  SUBSCRIPTION
}

enum Rating {
  EXCELLENT
  GOOD
  FAIR
  POOR
}
